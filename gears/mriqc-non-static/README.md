# MRIQC Gear

This gear is a duplicate of the [mriqc gear](https://gitlab.com/flywheel-io/scientific-solutions/gears/mriqc) maintained by Flywheel. It exists here because of a quirk in Flywheel's configuration for static gears, namely that they can't be dynamically provisioned to run on different size compute engines. The official mriqc gear is configured by Flywheel as a static gear but the compute resources dedicated to it are not always adequate for it to run successfully - a small percentage of runs fail due to lack of memory. Static gears always have a given instance hot for them to run on, which means that configuring mriqc to run on a larger instance would incur constant larger costs. Rather than incur those costs we decided to make this, a non-static version of the mriqc gear, allowing us dynamically provision the size of the compute engine when we need to run mriqc on a scan that requires more memory to complete successfully.

### Summary

*Image quality metrics for quality assessment of MRI. For more information see [MRIQC's documentation](http://mriqc.readthedocs.io).*

### Cite

*Esteban O, Birman D, Schaer M, Koyejo OO, Poldrack RA, Gorgolewski KJ; MRIQC: Advancing the Automatic Prediction of Image Quality in MRI from Unseen Sites; PLOS ONE 12(9):e0184661; doi:10.1371/journal.pone.0184661.*

### License 

*License:* *BSD-3-Clause*

### Classification

*Category:* *QA (Utility)*

*Gear Level:*

- [ ] Project
- [ ] Subject
- [ ] Session
- [x] Acquisition
- [ ] Analysis

----

[[_TOC_]]

----

### Inputs

- *nifti*
  - __Type__: *NIfTI file (.nii, .nii.gz)*
  - __Optional__: *False*
  - __Description__: *MRI NIfTI file. Input can be a structural image (T1, T2) or a functional NIfTI file.*
  - __Notes__: *Intent and Measurement classification fields must be present in the input metadata for 'auto-detect' mode to work.*

### Config

- *debug*
  - __Type__: *boolean*
  - __Description__: *Log debug messages*
  - __Default__: *False*

- *measurement*
  - __Type__: *"enum": ["auto-detect", "functional", "T1", "T2"]*
  - __Description__: *Measurement of the input image. Note: for "auto-detect" mode to work, the input nifti must have the Intent and Measurement classification fields present in its metadata.*
  - __Default__: *"auto-detect"*

- *verbose_reports*
  - __Type__: *boolean*
  - __Description__: *Produce [verbose report outputs](https://mriqc.readthedocs.io/en/latest/reports/smri.html#verbose-reports).*
  - __Default__: *False*


- *include_rating_widget*
  - __Type__: *boolean*
  - __Description__: *Include the MRIQC built-in rating widget (does not function in flywheel).*
  - __Default__: *False*


- *tag*
  - __Type__: *string*
  - __Description__: *Tag to add to the input file.*
  - __Default__: *mriqc*

- *save_derivatives*
  - __Type__: *boolean*
  - __Description__: *Save the derivative JSON file generated by MRIQC algorithm.
  - __Note__: The metrics produced in this document are saved as custom metadata to the input file regardless of whether this JSON is saved.
  - __Default__: *false*



### Outputs

#### Files

- *Report*
  - __Description__: *Zipped html archive. Contains .html report and .svg images.*
  - __Notes__: *Archive is viewable in Flywheel.*
  - __Optional__: *False*

- *Derivative JSON*
  - __Description__: *JSON file containing image quality metrics (IQM).*
  - __Notes__: *Only saved when 'save_derivatives' config option set to True.*
  - __Optional__: *True*


#### Metadata

Image quality metrics (IQM) are saved to the input nifti file as Custom Information fields, located under the "derived.IQM" keys.

### Pre-requisites

#### Prerequisite Metadata

1. __*Modality*__
    - Location: *Information*
    - Level: *File*
    - Note: *Must be MR - Magnetic Resonance*.
    - Note: *Only required when gear is run in "auto-detect" mode*.

1. __*Intent*__
    - Location: *Information.Modality(MR - Magnetic Resonance).Intent*
    - Level: *File*
    - Note: *Must be Structural or Functional*.
    - Note: *Only required when gear is run in "auto-detect" mode*.

1. __*Measurement*__
    - Location: *Information.Modality(MR - Magnetic Resonance).Measurement*
    - Level: *File*
    - Note: *Only required when gear is run in "auto-detect" mode*.
